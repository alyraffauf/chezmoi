{{ if eq .chezmoi.os "darwin" -}}
#!/usr/bin/env bash

set -euo pipefail

restart_dock=false
restart_finder=false
restart_systemui=false

# Apply defaults
{{- range .macos_defaults }}

# Read current value
current_val=$(defaults read "{{ .domain }}" "{{ .key }}" 2>/dev/null || echo "")

# Normalize current value for comparison
case "{{ .type }}" in
    bool|boolean)
        [[ "$current_val" == "1" ]] && current_val="true"
        [[ "$current_val" == "0" ]] && current_val="false"
        ;;
    int|integer)
        current_val=$(echo "$current_val" | tr -d ' ')
        ;;
esac

# Only apply if different
if [[ "$current_val" != "{{ .value }}" ]]; then
    if defaults write "{{ .domain }}" "{{ .key }}" "-{{ .type }}" "{{ .value }}" 2>/dev/null; then
        if [[ -n "$current_val" ]]; then
            echo "[defaults] {{ .domain }}.{{ .key }}: $current_val â†’ {{ .value }}"
        else
            echo "[defaults] {{ .domain }}.{{ .key }} = {{ .value }}"
        fi

        # Mark apps for restart based on domain
        case "{{ .domain }}" in
            com.apple.dock) restart_dock=true ;;
            com.apple.finder) restart_finder=true ;;
            NSGlobalDomain) restart_systemui=true ;;
        esac
    else
        echo "[defaults] ERROR: {{ .domain }}.{{ .key }} failed to set"
    fi
fi
{{- end }}

# Handle dock apps
# Dock apps require parsing aplist and are thus more complicated.
current_dock=$(defaults read com.apple.dock persistent-apps 2>/dev/null | \
  perl -nle 'print $1 if /_CFURLString.*"(.+?)"/' | \
  sed 's|file://||g' | sed 's|%20| |g' | sed 's|/$||' | \
  paste -sd '|' -)

desired_dock="{{ range .macos_dock_apps }}{{ . }}|{{ end }}"
desired_dock="${desired_dock%|}"

if [[ "$current_dock" != "$desired_dock" ]]; then
    defaults delete com.apple.dock persistent-apps 2>/dev/null || true
    defaults write com.apple.dock persistent-apps -array

    {{- range .macos_dock_apps }}
    defaults write com.apple.dock persistent-apps -array-add '<dict><key>tile-data</key><dict><key>file-data</key><dict><key>_CFURLString</key><string>{{ . }}</string><key>_CFURLStringType</key><integer>0</integer></dict></dict></dict>'
    {{- end }}

    echo "[defaults] updated {{ len .macos_dock_apps }} dock apps"
    restart_dock=true
fi

# Only restart applications if their settings changed
if [[ "$restart_dock" == true ]]; then
    killall Dock 2>/dev/null && echo "[defaults] restarted Dock"
fi

if [[ "$restart_finder" == true ]]; then
    killall Finder 2>/dev/null && echo "[defaults] restarted Finder"
fi

if [[ "$restart_systemui" == true ]]; then
    killall SystemUIServer 2>/dev/null && echo "[defaults] restarted SystemUIServer"
fi
{{ end -}}
